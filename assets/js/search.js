document.addEventListener('DOMContentLoaded', function () {
  const searchInput = document.getElementById('search-input');
  const resultsList = document.getElementById('search-results');
  const statusEl = document.getElementById('search-status');

  let idx = null;
  let documents = [];
  let lunrReady = false;
  // capture initial query from URL (e.g. /search/?q=term)
  const initialQuery = (typeof window !== 'undefined') ? (new URLSearchParams(window.location.search).get('q') || '') : '';

  function setStatus(msg) {
    if (statusEl) statusEl.textContent = msg;
  }

  // Fetch the prebuilt JSON index generated by Jekyll
  const searchJsonUrl = (window && window.SEARCH_JSON_URL) ? window.SEARCH_JSON_URL : '/search.json';
  fetch(searchJsonUrl)
    .then(res => res.json())
    .then(data => {
      documents = data.map((d, i) => Object.assign({id: i}, d));

      // Build lunr index
      idx = lunr(function () {
        this.ref('id');
        this.field('title', { boost: 10 });
        this.field('content');

        documents.forEach(function (doc) {
          this.add(doc);
        }, this);
      });

      lunrReady = true;
      setStatus('Search ready.');
      if (searchInput) {
        try { searchInput.focus(); } catch (e) {}
        if (initialQuery) {
          searchInput.value = initialQuery;
        }
      }
    })
    .catch(err => {
      console.error('Failed to load search index', err);
      setStatus('Search index failed to load.');
    });

  function createSnippet(text, query) {
    if (!text) return '';
    const q = query.trim().toLowerCase();
    if (!q) return text.slice(0, 200) + (text.length > 200 ? '…' : '');
    const idx = text.toLowerCase().indexOf(q);
    if (idx === -1) return text.slice(0, 200) + (text.length > 200 ? '…' : '');
    const start = Math.max(0, idx - 50);
    const end = Math.min(text.length, idx + 150);
    let snippet = text.slice(start, end);
    if (start > 0) snippet = '…' + snippet;
    if (end < text.length) snippet = snippet + '…';
    return snippet;
  }

  function renderResults(results, query) {
    resultsList.innerHTML = '';
    if (!results || results.length === 0) {
      setStatus('No results.');
      return;
    }

    setStatus(results.length + ' result' + (results.length > 1 ? 's' : '') + '.');

    const fragment = document.createDocumentFragment();
    results.forEach(r => {
      const doc = documents.find(d => String(d.id) === String(r.ref));
      if (!doc) return;

      const li = document.createElement('li');
      li.className = 'search-result';

      const a = document.createElement('a');
      a.href = doc.url;
      a.className = 'search-result-link';
      a.textContent = doc.title || doc.url;
      li.appendChild(a);

      const meta = document.createElement('div');
      meta.className = 'search-result-meta';
      if (doc.date) {
        const d = document.createElement('time');
        d.className = 'search-result-date';
        d.dateTime = doc.date;
        d.textContent = doc.date;
        meta.appendChild(d);
      }
      li.appendChild(meta);

      const snippet = document.createElement('p');
      snippet.className = 'search-result-snippet';
      snippet.textContent = createSnippet(doc.content || '', query);
      li.appendChild(snippet);

      fragment.appendChild(li);
    });

    resultsList.appendChild(fragment);
  }

  // Debounce helper
  function debounce(fn, wait) {
    let t;
    return function (...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  const doSearch = debounce(function () {
    const q = (searchInput.value || '').trim();
    if (!lunrReady) {
      setStatus('Search index not ready yet.');
      return;
    }
    if (!q) {
      resultsList.innerHTML = '';
      setStatus('');
      return;
    }

    // Build a basic lunr query: AND each term, use wildcard
    const terms = q.split(/\s+/).filter(Boolean);
    let lunrQuery = '';
    terms.forEach(t => {
      // require term and use wildcard
      lunrQuery += '+' + t + '* ';
    });

    try {
      const results = idx.search(lunrQuery);
      renderResults(results, q);
    } catch (e) {
      // fallback to simple single-term search
      try {
        const results = idx.search(q);
        renderResults(results, q);
      } catch (err) {
        console.error('Search error', err);
        setStatus('Search error.');
      }
    }
  }, 200);

  if (searchInput) {
    searchInput.addEventListener('input', doSearch);
    searchInput.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        searchInput.value = '';
        resultsList.innerHTML = '';
        setStatus('');
      }
    });
  }

  // If initialQuery exists (from ?q=) run search once index is built
  if (initialQuery) {
    // allow the debounced function to run and the index to be ready
    setTimeout(() => {
      try { doSearch(); } catch (e) {}
    }, 250);
  }

});
